# Istio/Envoy 扩展配置集合

本仓库提供基于 Istio/Envoy 的定制化配置方案，通过 EnvoyFilter 实现特殊业务场景需求，如动态路由、请求头注入等功能。所有方案均提供 Helm 模板，便于在 Kubernetes 环境中快速部署和管理。

## 目录
- [特点](#特点)
- [功能模块](#功能模块)
- [许可证](#许可证)

## 特点
- **多语言支持**：结合 Lua 脚本和 Golang 编写的 WASM 过滤器
- **Helm 集成**：所有功能模块提供 Helm Chart，支持参数化配置
- **场景化设计**：针对特定业务场景优化，如动态路由、多版本服务区分
- **Kubernetes 原生**：完全基于 Istio/Envoy 构建，与 Kubernetes 生态无缝集成

## 功能模块
### dynamic-forward
**功能概述**：动态提取 URL 参数中的十进制 IP 地址并转发至目标服务

**技术实现**：
- Lua 脚本实现 IP 地址转换（十进制 → 标准 IPv4 格式）
- 安全检查与动态路由配置
- 注入自定义请求头 "X-Host-Port"

**适用场景**：
> 游戏服务器房间分配、动态 Pod 路由等场景。当后端服务 Pod 地址不固定，但需将用户请求定向到特定实例时使用，例如：
> - 大厅服务分配游戏房间后，需将用户后续请求转发至固定房间服务器
> - 需要利用 Kubernetes 实现服务扩缩容，同时保持用户会话连续性
详细文档：[dynamic-forward](./dynamic-forward/README.md)

### add-header
**功能概述**：基于请求头信息动态添加 HTTP 请求头字段，支持多版本服务路由

**技术实现**：
- Golang 编写的 WASM 过滤器
- 本地缓存与内部 API 集成
- 动态请求头注入

**适用场景**：
> 多版本服务共享域名时的流量路由，例如：
> - 产品分为社区版/专业版，但需使用同一域名对外提供服务
> - 用户升级版本后无法变更客户端访问 URL（如受 SDK 限制）

**工作流程**：
1. **数据同步**：定时从内部 API 获取版本标识（如专业版 app_id 列表）并缓存
2. **请求解析**：请求到达时解析指定请求头字段（如 `X-App-ID`）
3. **头字段注入**：根据缓存的版本信息动态添加路由头（如 `X-Service-Version: pro`）
4. **路由决策**：后端服务基于新增头字段进行流量路由

详细文档：[add-header](./add-header/README.md)

## 许可证
本项目采用 [MIT 许可证](LICENSE)，详情请查看 LICENSE 文件。